# CI ç¯å¢ƒäººç±»è¡Œä¸ºæ¨¡æ‹Ÿé…ç½®ç¤ºä¾‹

# ============================================================
# GitHub Actions å·¥ä½œæµé…ç½®ç¤ºä¾‹
# ============================================================

# .github/workflows/checkin.yml
name: Auto Check-in with Behavior Simulation

on:
  schedule:
    # æ¯å¤© UTC 00:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  checkin:
    runs-on: ubuntu-latest

    env:
      # ============================================================
      # äººç±»è¡Œä¸ºæ¨¡æ‹Ÿé…ç½®
      # ============================================================

      # å¯ç”¨äººç±»è¡Œä¸ºæ¨¡æ‹Ÿï¼ˆé»˜è®¤ï¼štrueï¼‰
      # è®¾ç½®ä¸º false å¯ç¦ç”¨æ‰€æœ‰è¡Œä¸ºæ¨¡æ‹ŸåŠŸèƒ½
      CI_ENABLE_BEHAVIOR_SIMULATION: true

      # è¡Œä¸ºæ¨¡æ‹Ÿå¼ºåº¦ï¼ˆé»˜è®¤ï¼šmediumï¼‰
      # å¯é€‰å€¼ï¼šlight, medium, heavy
      # - light: è½»åº¦æ¨¡æ‹Ÿï¼Œå¿«é€Ÿä½†å¯èƒ½æ£€æµ‹ç‡è¾ƒé«˜
      # - medium: ä¸­åº¦æ¨¡æ‹Ÿï¼Œå¹³è¡¡æ€§èƒ½å’Œæ•ˆæœï¼ˆæ¨èï¼‰
      # - heavy: é‡åº¦æ¨¡æ‹Ÿï¼Œæ…¢ä½†æœ€åƒçœŸäºº
      CI_BEHAVIOR_INTENSITY: medium

      # ============================================================
      # å…¶ä»– CI é…ç½®ï¼ˆå¯é€‰ï¼‰
      # ============================================================

      # é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ï¼š3ï¼‰
      CI_RETRY_COUNT: 3

      # è¶…æ—¶æ—¶é—´å€å¢å™¨ï¼ˆé»˜è®¤ï¼š2.0ï¼‰
      # CI ç¯å¢ƒä¸‹çš„è¶…æ—¶æ—¶é—´ä¼šä¹˜ä»¥è¿™ä¸ªå€æ•°
      CI_TIMEOUT_MULTIPLIER: 2.0

      # æ˜¯å¦ä½¿ç”¨å»¶é•¿çš„ç­‰å¾…æ—¶é—´ï¼ˆé»˜è®¤ï¼štrueï¼‰
      CI_EXTENDED_WAIT: true

      # è·³è¿‡ Cloudflare éªŒè¯æ£€æŸ¥ï¼ˆé»˜è®¤ï¼šfalseï¼‰
      # ä»…ç”¨äºè°ƒè¯•ï¼Œç”Ÿäº§ç¯å¢ƒä¸å»ºè®®è®¾ç½®ä¸º true
      SKIP_CLOUDFLARE_CHECK: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium

      - name: Run check-in
        run: python checkin.py
        env:
          # ä» GitHub Secrets è¯»å–æ•æ„Ÿä¿¡æ¯
          ACCOUNTS_JSON: ${{ secrets.ACCOUNTS_JSON }}


# ============================================================
# åœºæ™¯ 1: é«˜éªŒè¯é€šè¿‡ç‡ä¼˜å…ˆï¼ˆæ¨èç”¨äºé¢‘ç¹è¢« Cloudflare æ‹¦æˆªçš„æƒ…å†µï¼‰
# ============================================================

jobs:
  checkin-high-success-rate:
    runs-on: ubuntu-latest
    env:
      CI_ENABLE_BEHAVIOR_SIMULATION: true
      CI_BEHAVIOR_INTENSITY: heavy      # ä½¿ç”¨é‡åº¦æ¨¡æ‹Ÿ
      CI_TIMEOUT_MULTIPLIER: 3.0        # å¢åŠ è¶…æ—¶å€æ•°
      CI_RETRY_COUNT: 5                 # å¢åŠ é‡è¯•æ¬¡æ•°


# ============================================================
# åœºæ™¯ 2: å¿«é€Ÿè¿è¡Œä¼˜å…ˆï¼ˆæ¨èç”¨äºç¨³å®šç¯å¢ƒæˆ–æ—¶é—´æ•æ„Ÿä»»åŠ¡ï¼‰
# ============================================================

jobs:
  checkin-fast:
    runs-on: ubuntu-latest
    env:
      CI_ENABLE_BEHAVIOR_SIMULATION: true
      CI_BEHAVIOR_INTENSITY: light      # ä½¿ç”¨è½»åº¦æ¨¡æ‹Ÿ
      CI_TIMEOUT_MULTIPLIER: 1.5        # å‡å°è¶…æ—¶å€æ•°
      CI_RETRY_COUNT: 2                 # å‡å°‘é‡è¯•æ¬¡æ•°


# ============================================================
# åœºæ™¯ 3: è°ƒè¯•æ¨¡å¼ï¼ˆç”¨äºæ’æŸ¥é—®é¢˜ï¼‰
# ============================================================

jobs:
  checkin-debug:
    runs-on: ubuntu-latest
    env:
      CI_ENABLE_BEHAVIOR_SIMULATION: false  # ç¦ç”¨è¡Œä¸ºæ¨¡æ‹Ÿä»¥è§‚å¯ŸåŸå§‹è¡Œä¸º
      SKIP_CLOUDFLARE_CHECK: true           # è·³è¿‡ Cloudflare æ£€æŸ¥
      CI_TIMEOUT_MULTIPLIER: 1.0            # ä¸å¢åŠ è¶…æ—¶
      # å¯ç”¨è¯¦ç»†æ—¥å¿—
      PYTHONUNBUFFERED: 1


# ============================================================
# åœºæ™¯ 4: A/B æµ‹è¯•ï¼ˆåŒæ—¶è¿è¡Œå¤šç§é…ç½®è¿›è¡Œå¯¹æ¯”ï¼‰
# ============================================================

jobs:
  # å¯ç”¨è¡Œä¸ºæ¨¡æ‹Ÿ
  checkin-with-simulation:
    runs-on: ubuntu-latest
    env:
      CI_ENABLE_BEHAVIOR_SIMULATION: true
      CI_BEHAVIOR_INTENSITY: medium
    steps:
      - uses: actions/checkout@v3
      - run: python checkin.py

  # ä¸å¯ç”¨è¡Œä¸ºæ¨¡æ‹Ÿ
  checkin-without-simulation:
    runs-on: ubuntu-latest
    env:
      CI_ENABLE_BEHAVIOR_SIMULATION: false
    steps:
      - uses: actions/checkout@v3
      - run: python checkin.py


# ============================================================
# æœ¬åœ°æµ‹è¯•é…ç½®ç¤ºä¾‹
# ============================================================

# åœ¨æœ¬åœ°æµ‹è¯•æ—¶ï¼Œå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æ¨¡æ‹Ÿ CI ç¯å¢ƒï¼š

# Windows (PowerShell):
$env:CI="true"
$env:CI_ENABLE_BEHAVIOR_SIMULATION="true"
$env:CI_BEHAVIOR_INTENSITY="medium"
python checkin.py

# Linux/macOS (Bash):
export CI=true
export CI_ENABLE_BEHAVIOR_SIMULATION=true
export CI_BEHAVIOR_INTENSITY=medium
python checkin.py


# ============================================================
# Docker é…ç½®ç¤ºä¾‹
# ============================================================

# docker-compose.yml
version: '3.8'

services:
  checkin:
    image: python:3.11-slim
    environment:
      - CI=true
      - CI_ENABLE_BEHAVIOR_SIMULATION=true
      - CI_BEHAVIOR_INTENSITY=medium
      - CI_TIMEOUT_MULTIPLIER=2.0
    volumes:
      - .:/app
    working_dir: /app
    command: python checkin.py


# ============================================================
# GitLab CI é…ç½®ç¤ºä¾‹
# ============================================================

# .gitlab-ci.yml
checkin:
  stage: deploy
  image: python:3.11
  variables:
    CI_ENABLE_BEHAVIOR_SIMULATION: "true"
    CI_BEHAVIOR_INTENSITY: "medium"
    CI_TIMEOUT_MULTIPLIER: "2.0"
  script:
    - pip install -r requirements.txt
    - playwright install chromium
    - python checkin.py
  only:
    - schedules


# ============================================================
# CircleCI é…ç½®ç¤ºä¾‹
# ============================================================

# .circleci/config.yml
version: 2.1

jobs:
  checkin:
    docker:
      - image: cimg/python:3.11
    environment:
      CI_ENABLE_BEHAVIOR_SIMULATION: true
      CI_BEHAVIOR_INTENSITY: medium
    steps:
      - checkout
      - run: pip install -r requirements.txt
      - run: playwright install chromium
      - run: python checkin.py

workflows:
  scheduled-checkin:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only: main
    jobs:
      - checkin


# ============================================================
# é…ç½®å»ºè®®
# ============================================================

# 1. é¦–æ¬¡ä½¿ç”¨å»ºè®®
#    - ä½¿ç”¨ medium å¼ºåº¦
#    - å¯ç”¨å»¶é•¿ç­‰å¾…
#    - ä¿æŒé»˜è®¤é‡è¯•æ¬¡æ•°

# 2. ä¼˜åŒ–å»ºè®®
#    - å¦‚æœéªŒè¯æˆåŠŸç‡ä½äº 70%ï¼Œæé«˜å¼ºåº¦åˆ° heavy
#    - å¦‚æœè¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œé™ä½å¼ºåº¦åˆ° light
#    - æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´è¶…æ—¶å€æ•°

# 3. ç›‘æ§æŒ‡æ ‡
#    - éªŒè¯æˆåŠŸç‡
#    - å¹³å‡è¿è¡Œæ—¶é—´
#    - Cloudflare æ‹¦æˆªæ¬¡æ•°
#    - é‡è¯•æ¬¡æ•°

# 4. æ•…éšœæ’æŸ¥
#    - æŸ¥çœ‹æ—¥å¿—ä¸­çš„ "ğŸ¤– CI ç¯å¢ƒï¼š..." ä¿¡æ¯
#    - æ£€æŸ¥è¡Œä¸ºæ¨¡æ‹Ÿæ˜¯å¦çœŸæ­£å¯ç”¨
#    - å°è¯•ä¸åŒçš„å¼ºåº¦çº§åˆ«
#    - è€ƒè™‘å¢åŠ é¢å¤–çš„åæ£€æµ‹æªæ–½
