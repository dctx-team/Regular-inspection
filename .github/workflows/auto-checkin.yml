name: Router è‡ªåŠ¨ç­¾åˆ°

on:
  # å®šæ—¶æ‰§è¡Œ - æ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */6 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      manual_run:
        description: 'æ‰‹åŠ¨è§¦å‘ç­¾åˆ°'
        required: false
        default: 'true'

jobs:
  checkin:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: write  # å…è®¸æäº¤å’ŒæŽ¨é€æ›´æ”¹

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: èŽ·å– Playwright ç‰ˆæœ¬
        id: playwright-version
        run: |
          PLAYWRIGHT_VERSION=$(python -c "from importlib.metadata import version; print(version('playwright'))")
          echo "version=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT
          echo "Playwright version: $PLAYWRIGHT_VERSION"

      - name: ç¼“å­˜ Playwright æµè§ˆå™¨
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: å®‰è£… Playwright æµè§ˆå™¨
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: è®¾ç½® Clash ä»£ç†ï¼ˆå¯é€‰ï¼‰
        if: ${{ secrets.PROXY_SUBSCRIPTION_URL != '' }}
        run: |
          echo "=== ðŸ“¡ å¼€å§‹é…ç½® Clash ä»£ç† ==="

          # ä¸‹è½½ Clash Premium
          echo "ðŸ“¥ ä¸‹è½½ Clash Premium..."
          wget -O clash.gz https://github.com/Dreamacro/clash/releases/download/premium/clash-linux-amd64-2023.08.17.gz
          gunzip clash.gz
          chmod +x clash

          # ç”Ÿæˆ Clash é…ç½®æ–‡ä»¶
          echo "ðŸ“ ç”Ÿæˆ Clash é…ç½®..."
          cat > config.yaml << 'EOF'
          mixed-port: 7890
          allow-lan: false
          mode: rule
          log-level: info
          external-controller: 127.0.0.1:9090

          proxy-providers:
            my-provider:
              type: http
              url: ${{ secrets.PROXY_SUBSCRIPTION_URL }}
              interval: 3600
              path: ./subscription.yaml
              health-check:
                enable: true
                interval: 300
                url: http://www.gstatic.com/generate_204

          proxies: []

          proxy-groups:
            - name: PROXY
              type: url-test
              use:
                - my-provider
              url: http://www.gstatic.com/generate_204
              interval: 300

          rules:
            - MATCH,PROXY
          EOF

          # å¯åŠ¨ Clashï¼ˆåŽå°è¿è¡Œï¼‰
          echo "ðŸš€ å¯åŠ¨ Clash..."
          ./clash -f config.yaml &
          CLASH_PID=$!
          echo "Clash PID: $CLASH_PID"

          # ç­‰å¾… Clash å¯åŠ¨å®Œæˆ
          echo "â³ ç­‰å¾… Clash å¯åŠ¨..."
          sleep 10

          # æµ‹è¯•ä»£ç†æ˜¯å¦å¯ç”¨
          echo "ðŸ” æµ‹è¯•ä»£ç†è¿žæŽ¥..."
          if curl -x http://127.0.0.1:7890 -s -o /dev/null -w "%{http_code}" https://www.google.com | grep -q "200"; then
            echo "âœ… Clash ä»£ç†å¯åŠ¨æˆåŠŸ"
          else
            echo "âš ï¸ ä»£ç†æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
          fi

      - name: æ‰§è¡Œç­¾åˆ°
        env:
          # è´¦å·é…ç½®
          ANYROUTER_ACCOUNTS: ${{ secrets.ANYROUTER_ACCOUNTS }}
          AGENTROUTER_ACCOUNTS: ${{ secrets.AGENTROUTER_ACCOUNTS }}
          ACCOUNTS: ${{ secrets.ACCOUNTS }}
          PROVIDERS: ${{ secrets.PROVIDERS }}

          # é€šçŸ¥é…ç½®
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          CUSTOM_SMTP_SERVER: ${{ secrets.CUSTOM_SMTP_SERVER }}
          DINGDING_WEBHOOK: ${{ secrets.DINGDING_WEBHOOK }}
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          WEIXIN_WEBHOOK: ${{ secrets.WEIXIN_WEBHOOK }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          SERVERPUSHKEY: ${{ secrets.SERVERPUSHKEY }}

          # ä»£ç†é…ç½®ï¼ˆä½¿ç”¨æœ¬åœ° Clash æä¾›çš„ HTTP ä»£ç†ï¼‰
          USE_PROXY: ${{ secrets.PROXY_SUBSCRIPTION_URL != '' && 'true' || 'false' }}
          PROXY_SERVER: http://127.0.0.1:7890

          # ä»£ç†ç»†ç²’åº¦æŽ§åˆ¶ï¼ˆå¯é€‰ï¼‰
          PROXY_METHODS: ${{ secrets.PROXY_METHODS }}
          NO_PROXY_METHODS: ${{ secrets.NO_PROXY_METHODS }}

          # CI çŽ¯å¢ƒä¼˜åŒ–
          CI_DISABLED_AUTH_METHODS: ${{ secrets.CI_DISABLED_AUTH_METHODS }}
          SESSION_CACHE_KEY: ${{ secrets.SESSION_CACHE_KEY }}
        run: |
          python main.py

      - name: æäº¤ä½™é¢æ•°æ®
        if: always()
        run: |
          echo "=== æ£€æŸ¥ä½™é¢æ•°æ®æ–‡ä»¶ ==="
          ls -lh balance_data.json balance_hash.txt || echo "æ–‡ä»¶ä¸å­˜åœ¨"

          echo "=== é…ç½® Git ==="
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          echo "=== æ£€æŸ¥ Git çŠ¶æ€ ==="
          git status

          echo "=== æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº ==="
          git add balance_data.json balance_hash.txt || echo "æ·»åŠ æ–‡ä»¶å¤±è´¥"

          echo "=== æ£€æŸ¥æš‚å­˜åŒº ==="
          git diff --staged --name-only

          echo "=== æäº¤æ›´æ”¹ ==="
          if ! git diff --staged --quiet; then
            git commit -m "è‡ªåŠ¨æ›´æ–°ä½™é¢æ•°æ® [skip ci]"
            echo "=== æŽ¨é€åˆ°è¿œç¨‹ ==="
            git push
            echo "âœ… ä½™é¢æ•°æ®å·²æäº¤å¹¶æŽ¨é€"
          else
            echo "âš ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          fi

      - name: ä¸Šä¼ ä½™é¢è®°å½•ï¼ˆå¤‡ä»½ï¼‰
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: balance-data-${{ github.run_number }}
          path: |
            balance_hash.txt
            balance_data.json
          retention-days: 7
